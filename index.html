<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Frota Mobile</title>
</head>

<body>
    <h1>Sua Frota</h1>
    <button id="btnStart">Start</button>
    <button id="btnStop">Stop</button>
    <h3>Status Message:</h3>
    <h3 id="displayStatus">...</h3>
    <h3>Display Position:</h3>
    <h3 id="displayPosition">...</h3>

    <script>
        let btnStart = document.getElementById('btnStart');
        let btnStop = document.getElementById('btnStop');
        let displayStatus = document.getElementById('displayStatus');
        let stop = false;



        let displayPosition = document.getElementById('displayPosition');
        let dadosColetados = [];
        let intervalId;
        // let texto = '';

        function delay(milliseconds) {
            return new Promise(resolve => {
                setTimeout(resolve, milliseconds);
            });
        }

        async function returnPosition(timeDelay) {
            console.log('return position');
            await delay(timeDelay);
            await navigator.geolocation.getCurrentPosition((posicao) => {
                let now = new Date();
                let lat = posicao.coords.latitude;
                let long = posicao.coords.longitude;
                dadosColetados.push({
                    time: now,
                    latitude: lat,
                    longitude: long
                })
                // texto = texto + '\ntime:' + now + '\nlatitude: ' + lat + '   longitude: ' + long + '\n';
            });
            displayStatus.innerText = 'return position qtd dados coletados: ' + dadosColetados.length;
        }

        async function requestScreenWakeLock() {
            let wakelock = await navigator.wakeLock.request("screen");
            // displayStatus.innerText = (wakelock != null);
        }

        async function runLoop() {
            requestScreenWakeLock();
            let inc = 0;
            while (true) {
                if (stop) { break }
                inc = inc + 1;
                console.log('runLoop');
                await returnPosition(5000);
                // displayPosition.innerText = `iteração: ${inc}`;
            }
        }


        btnStart.onclick = () => {
            console.log('start');
            runLoop();
        }

        btnStop.onclick = async () => {
            let texto = '';
            stop = true;
            // await delay(5000);
            console.log('stop');
            console.log('qtd dados coletados: ' + dadosColetados.length);
            dadosColetados.forEach(element => {
                texto = texto + '\ntime:' + element.time + '\nlatitude: ' + element.latitude + '   longitude: ' + element.longitude + '\n';
                displayPosition.innerText = texto;
            })

        }









    </script>
</body>

</html>